<!DOCTYPE html>
<html>
<head>
    <title>HomeBrain Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    <style>
        :root {
            --hb-green: #2ecc71;
            --hb-green-hover: #27ae60;
            --hb-bg: #121212;
            --hb-card: #1e1e1e;
            --hb-border: #333;
            --hb-text-main: #eee;
            --hb-text-dim: #aaa;
            --hb-danger: #c0392b;
            --hb-danger-hover: #e74c3c;
            --hb-warning: #f39c12;
        }

        body {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--hb-bg);
            color: var(--hb-text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }

        /* --- Header Branding --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--hb-border);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 2em;
            font-weight: 300;
            letter-spacing: -1px;
            color: #fff;
            margin: 0;
            line-height: 1;
        }
        .logo span { color: var(--hb-green); font-weight: 700; }
        .logo small { font-size: 0.4em; color: var(--hb-text-dim); font-weight: 400; letter-spacing: 0; display: block; margin-top: 4px; }

        .header-status { text-align: right; }
        .global-status { font-weight: bold; color: var(--hb-green); font-size: 1.1em; }
        .provider-mode { font-size: 0.85em; color: var(--hb-text-dim); margin-top: 4px; }

        /* --- Navigation Tabs --- */
        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--hb-border);
            padding-bottom: 0;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            color: var(--hb-text-dim);
            font-weight: 600;
            font-size: 1em;
            transition: all 0.2s ease;
            position: relative;
            top: 1px;
            border-bottom: 3px solid transparent;
            border-radius: 4px 4px 0 0;
        }

        .tab-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .tab-btn.active {
            color: var(--hb-green);
            border-bottom: 3px solid var(--hb-green);
            background: linear-gradient(to top, rgba(46, 204, 113, 0.1), transparent);
        }

        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Cards & Grid --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 25px;
        }

        .card {
            background: var(--hb-card);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .card:hover { border-color: #444; }

        .card h3 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.3em;
            color: #fff;
            font-weight: 600;
            border-bottom: 1px solid #333;
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card p { font-size: 0.95em; color: #ccc; margin-bottom: 15px; }

        /* --- Buttons & Inputs --- */
        button {
            background-color: #333;
            color: #fff;
            border: 1px solid #444;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 0.9em;
        }
        button:hover { background-color: #444; border-color: #666; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .btn-primary {
            background-color: var(--hb-green);
            color: #000;
            font-weight: 700;
            border: none;
            box-shadow: 0 2px 10px rgba(46, 204, 113, 0.2);
        }
        .btn-primary:hover { background-color: var(--hb-green-hover); box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3); }

        .btn-danger { background-color: var(--hb-danger); color: white; border: none; }
        .btn-danger:hover { background-color: var(--hb-danger-hover); }

        .btn-warning { background-color: rgba(243, 156, 18, 0.2); color: var(--hb-warning); border: 1px solid var(--hb-warning); }
        .btn-warning:hover { background-color: var(--hb-warning); color: #121212; }

        input, select {
            background: #2a2a2a;
            color: #fff;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 6px;
            width: 100%;
            margin-bottom: 15px;
            font-size: 0.95em;
            box-sizing: border-box; /* Fix width issues */
        }
        input:focus, select:focus { border-color: var(--hb-green); outline: none; }

        label {
            color: var(--hb-text-dim);
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: block;
        }

        /* --- Specific UI Elements --- */
        .status-badge {
            padding: 4px 10px;
            border-radius: 50px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.7em;
            letter-spacing: 1px;
            display: inline-block;
        }
        .status-running { background: rgba(46, 204, 113, 0.15); color: var(--hb-green); border: 1px solid rgba(46, 204, 113, 0.3); }
        .status-stopped { background: rgba(231, 76, 60, 0.15); color: #e74c3c; border: 1px solid rgba(231, 76, 60, 0.3); }
        .status-unknown { background: #333; color: #aaa; border: 1px solid #444; }
        .status-starting { background: rgba(243, 156, 18, 0.15); color: var(--hb-warning); border: 1px solid rgba(243, 156, 18, 0.3); }

        .progress-bg {
            background: #2a2a2a;
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 8px;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        .progress-fill {
            background: var(--hb-green);
            height: 100%;
            width: 0%;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 0;
            font-size: 0.8em;
            font-weight: bold;
            line-height: 24px;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            z-index: 2;
        }

        .log-box {
            background: #000;
            color: #aaddaa;
            font-family: 'Consolas', 'Monaco', monospace;
            height: 400px;
            overflow-y: scroll;
            padding: 15px;
            border-radius: 8px;
            font-size: 13px;
            border: 1px solid #333;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.5);
            line-height: 1.4;
        }

        .log-line { margin-bottom: 2px; }
        .log-error { color: #ff6b6b; font-weight: bold; }
        .log-warning { color: #feca57; }
        .log-info { color: #aaddaa; }
        .log-debug { color: #54a0ff; }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .stat-item:last-child { border-bottom: none; }
        .stat-item span:first-child { color: var(--hb-text-dim); }
        .stat-item span:last-child { font-family: 'Consolas', monospace; color: #fff; }

        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th { text-align: left; padding: 10px; color: var(--hb-text-dim); border-bottom: 2px solid #333; font-weight: 600; text-transform: uppercase; font-size: 0.8em;}
        td { padding: 12px 10px; border-bottom: 1px solid #333; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        hr { border: 0; height: 1px; background: #333; margin: 20px 0; }

        .drive-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2a2a2a;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #333;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1 class="logo">Home<span>Brain</span><small>Private Cloud Manager</small></h1>
        <div class="header-status">
            <div id="global-status" class="global-status">System Active</div>
            <div class="provider-mode">Tunnel: {{ tunnel.mode.upper() }}</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('status')">Status</button>
        <button class="tab-btn" onclick="openTab('backup')">Backup & Storage</button>
        <button class="tab-btn" onclick="openTab('connectivity')">Connectivity</button>
        <button class="tab-btn" onclick="openTab('settings')">Settings</button>
        <button class="tab-btn" onclick="openTab('logs')">Logs</button>
    </div>

    <div id="status" class="tab-content active">
        <div class="grid">
            <div class="card">
                <h3>Services</h3>
                <div class="stat-item"><span>Nextcloud</span> <span id="st-nc" class="status-badge status-unknown">...</span></div>
                <div class="stat-item"><span>Database</span> <span id="st-db" class="status-badge status-unknown">...</span></div>
                <div class="stat-item"><span>Home Assistant</span> <span id="st-ha" class="status-badge status-unknown">...</span></div>
                <div class="stat-item"><span>Tunnel</span> <span id="st-tunnel" class="status-badge status-unknown">...</span></div>
                
                <div style="margin-top:25px; display:flex; gap:15px;">
                    <a href="https://{{ nc_domain }}" target="_blank" style="flex:1"><button class="btn-primary" style="width:100%">Open Nextcloud</button></a>
                    <a href="https://{{ ha_domain }}" target="_blank" style="flex:1"><button class="btn-primary" style="width:100%">Open Home Assistant</button></a>
                </div>
            </div>

            <div class="card">
                <h3>System Resources</h3>
                <div class="stat-item"><span>CPU Load</span> <span id="sys-cpu">...</span></div>
                <div class="stat-item"><span>RAM Usage</span> <span id="sys-ram">...</span></div>

                <div style="margin-top: 20px;">
                    <label>Root Filesystem</label>
                    <div class="progress-bg">
                        <div class="progress-fill" id="root-bar"></div>
                        <div class="progress-text" id="root-text">Checking...</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Maintenance & Updates</h3>
                <div class="stat-item"><span>Maintenance Mode</span> <span id="st-maint">Checking...</span></div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button onclick="toggleMaintenance('on')" style="flex:1">Enable</button>
                    <button onclick="toggleMaintenance('off')" style="flex:1">Disable</button>
                </div>
                
                <hr>
                
                <label>System Update Channel</label>
                <div style="display:flex; gap:10px;">
                    <select id="update-channel" onchange="resetUpdateUI()" style="margin-bottom:0; flex:2;">
                        <option value="stable">Stable (Releases)</option>
                        <option value="beta">Beta (Main Branch)</option>
                    </select>
                    <button onclick="triggerAction('/api/upgrade', 'System Upgrade')" style="flex:1;">OS Upgrade</button>
                </div>

                <div style="margin-top: 15px; display:flex; align-items:center; gap:10px;">
                    <button id="btn-check-update" onclick="checkManagerUpdate()">Check App Update</button>
                    <button id="btn-do-update" class="btn-primary" onclick="doManagerUpdate()" style="display:none;">Update Now</button>
                    <span id="update-msg" style="font-size: 0.85em; color:var(--hb-text-dim);"></span>
                </div>
            </div>
        </div>
    </div>

    <div id="backup" class="tab-content">
        <div class="grid">
            <div class="card">
                <h3>Drive Management</h3>
                <p>Manage external USB storage devices.</p>
                <div id="drive-list" style="margin-bottom:15px;">Loading drives...</div>
                <button onclick="loadDrives()">Scan for Drives</button>

                <hr>
                
                <label>Backup Drive Usage</label>
                <div id="disk-stats">
                    <div class="progress-bg">
                        <div class="progress-fill" id="disk-bar"></div>
                        <div class="progress-text" id="disk-text">Not Mounted</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Backup Schedule</h3>
                <form onsubmit="saveBackupConfig(event)">
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap:15px;">
                        <div>
                            <label>Retention (Snapshots)</label>
                            <input type="number" id="bk-retention" min="1" max="50">
                        </div>
                        <div>
                            <label>Frequency</label>
                            <select id="bk-freq" onchange="updateFreqUI()">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                    </div>

                    <div id="ui-dow" style="display:none;">
                        <label>Day of Week</label>
                        <select id="bk-dow">
                            <option value="0">Sunday</option><option value="1">Monday</option><option value="2">Tuesday</option>
                            <option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option>
                        </select>
                    </div>

                    <div id="ui-dom" style="display:none;">
                        <label>Day of Month</label>
                        <input type="number" id="bk-dom" min="1" max="31" value="1">
                    </div>

                    <label>Time (24h)</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="bk-hour"></select>
                        <select id="bk-min"><option value="0">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option></select>
                    </div>
                    <button type="submit" class="btn-primary" style="width:100%; margin-top:10px;">Save Schedule</button>
                </form>
                
                <hr>
                <label>Manual Action</label>
                <div style="display:flex; gap:10px;">
                    <select id="backup-strategy" style="margin-bottom:0;">
                        <option value="full">Full System (DB + Files + Config)</option>
                        <option value="data_only">Files Only (Fast)</option>
                    </select>
                    <button onclick="runBackup()">Run Now</button>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top:25px;">
            <h3>Restore Data</h3>
            <p>Select a backup file to restore. <strong style="color:var(--hb-danger)">Warning: This overwrites current data!</strong></p>
            <div style="display:flex; gap:10px; align-items:center;">
                <select id="backup-list" style="margin-bottom:0; flex-grow:1;"></select>
                <button class="btn-danger" onclick="confirmRestore()">Restore Selected</button>
            </div>
        </div>
    </div>

    <div id="connectivity" class="tab-content">
        <div class="card" style="border-left: 4px solid var(--hb-green);">
             <h3 style="border-bottom:none; margin-bottom:10px;">Authentication</h3>
             <p style="margin-bottom:0;">The <strong>Master Admin Password</strong> controls access to HomeBrain Manager, Nextcloud, and Home Assistant.</p>
        </div>

        <div class="card">
            <h3>Tunnel Configuration</h3>

            {% if tunnel.mode == 'pangolin' %}
            <div style="background:rgba(46, 204, 113, 0.1); border:1px solid var(--hb-green); padding:15px; border-radius:6px; margin-bottom:20px;">
                <span style="color:var(--hb-green); font-weight:bold;">Active Provider: Pangolin</span>
                {% if tunnel.is_custom_pangolin %}<span style="font-size:0.8em; margin-left:10px; opacity:0.7;">(Customized)</span>{% endif %}
            </div>

            <form onsubmit="updatePangolin(event)">
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap:15px;">
                    <div><label>Endpoint</label><input type="text" id="tun-ep" value="{{ tunnel.current.PANGOLIN_ENDPOINT }}"></div>
                    <div><label>Device ID</label><input type="text" id="tun-id" value="{{ tunnel.current.NEWT_ID }}"></div>
                </div>
                <label>Secret Key</label><input type="password" id="tun-sec" value="{{ tunnel.current.NEWT_SECRET }}">
                
                <hr>
                
                <label>Main Domain (e.g. myserver.homebrain.com)</label>
                <input type="text" id="tun-main-domain" value="{{ main_domain }}">
                
                <div style="font-size: 0.85em; color: var(--hb-text-dim); padding: 10px; background: #222; border-radius: 4px; margin-bottom:15px;">
                    <strong>Subdomain Preview:</strong><br>
                    Manager: <span id="preview-mgr" style="color:#fff">{{ main_domain }}</span><br>
                    Nextcloud: nc.<span id="preview-nc" style="color:#fff">{{ main_domain }}</span><br>
                    Home Assistant: ha.<span id="preview-ha" style="color:#fff">{{ main_domain }}</span>
                </div>

                <button type="submit">Update Connection Settings</button>
            </form>

            {% if tunnel.is_custom_pangolin %}
            <div style="margin-top:20px; text-align:right;">
                <button class="btn-danger" onclick="revertPangolin()" style="font-size:0.8em;">Reset to Factory Defaults</button>
            </div>
            {% endif %}

            <hr>
            
            <label>Switch Provider</label>
            <p>You can switch to Cloudflare Tunnel if you have your own domain.</p>
            <button class="btn-warning" onclick="showCloudflareForm()">Switch to Cloudflare</button>

            <div id="cf-form-container" style="display:none; margin-top:20px; background: #222; padding: 20px; border-radius: 8px; border:1px solid #444;">
                <h4 style="margin-top:0; color:var(--hb-warning)">Cloudflare Setup</h4>
                <p style="font-size:0.9em;">Configure public hostnames in Cloudflare Dashboard pointing to <code>http://nextcloud:80</code> and <code>http://homeassistant:8123</code>.</p>
                <form onsubmit="updateCloudflare(event, 'switch')">
                    <label>Service</label>
                    <select id="cf-switch-service">
                        <option value="nc">Nextcloud</option>
                        {% if ha_domain %}<option value="ha">Home Assistant</option>{% endif %}
                    </select>
                    <label>Domain (e.g. cloud.mydomain.com)</label>
                    <input type="text" id="cf-switch-domain" required>
                    <label>Tunnel Token</label>
                    <input type="text" id="cf-switch-token" placeholder="eyJhIjoi..." required>
                    <button type="submit" class="btn-warning">Activate Cloudflare</button>
                </form>
            </div>

            {% else %}
            <div style="background:rgba(243, 156, 18, 0.1); border:1px solid var(--hb-warning); padding:15px; border-radius:6px; margin-bottom:20px;">
                <span style="color:var(--hb-warning); font-weight:bold;">Active Provider: Cloudflare</span>
            </div>

            <div style="margin-bottom:20px;">
                <label>Active Tunnels</label>
                <ul style="list-style:none; padding:0; margin:0; font-size:0.9em; color:#ccc;">
                    <li style="padding:5px 0; border-bottom:1px solid #333;">
                        <strong>Nextcloud:</strong> 
                        {% if tunnel.current.CF_TOKEN_NC %}<span style="color:var(--hb-green)">Configured</span>{% else %}<span style="color:#666">Inactive</span>{% endif %}
                    </li>
                    <li style="padding:5px 0;">
                        <strong>Home Assistant:</strong> 
                        {% if tunnel.current.CF_TOKEN_HA %}<span style="color:var(--hb-green)">Configured</span>{% else %}<span style="color:#666">Inactive</span>{% endif %}
                    </li>
                </ul>
            </div>

            <hr>
            <label>Update Configuration</label>
            <form onsubmit="updateCloudflare(event, 'update')">
                <div class="grid" style="grid-template-columns: 1fr 2fr; gap:10px;">
                    <div><select id="cf-update-service"><option value="nc">Nextcloud</option>{% if ha_domain %}<option value="ha">Home Assistant</option>{% endif %}</select></div>
                    <div><input type="text" id="cf-update-domain" placeholder="Domain"></div>
                </div>
                <input type="text" id="cf-update-token" placeholder="Tunnel Token" required>
                <button type="submit">Save Tunnel</button>
            </form>

            <div style="margin-top:30px; text-align:center;">
                <button class="btn-danger" onclick="revertToFactory()">Disable Cloudflare & Revert to Factory</button>
            </div>
            {% endif %}
        </div>
    </div>

    <div id="settings" class="tab-content">
        <div class="grid">
            
            <div class="card">
                <h3>System Configuration</h3>
                <p>Advanced hardware and task management.</p>

                <table style="margin-top:10px;">
                    <tr>
                        <td>
                            <strong>Hardware Watchdog</strong><br>
                            <small style="color:var(--hb-text-dim);">Auto-reboots system if frozen.</small>
                        </td>
                        <td style="text-align:right;">
                            <span id="sys-wd-status" class="status-badge status-unknown">...</span>
                            <button onclick="toggleSystem('watchdog')" style="margin-left:10px; padding:4px 10px; font-size:0.8em;">Toggle</button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <strong>Nextcloud Cron</strong><br>
                            <small style="color:var(--hb-text-dim);">Use system cron (Reliable).</small>
                        </td>
                        <td style="text-align:right;">
                            <span id="sys-cron-status" class="status-badge status-unknown">...</span>
                            <button onclick="toggleSystem('cron')" style="margin-left:10px; padding:4px 10px; font-size:0.8em;">Enforce</button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <strong>PCIe Speed</strong><br>
                            <small style="color:var(--hb-text-dim);">Gen 3.0 (Experimental).</small>
                        </td>
                        <td style="text-align:right;">
                            <span id="sys-pci-status" class="status-badge status-unknown">...</span>
                            <button onclick="toggleSystem('pci')" style="margin-left:10px; padding:4px 10px; font-size:0.8em;">Toggle</button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <strong>Redis Caching</strong><br>
                            <small style="color:var(--hb-text-dim);">High-performance memory caching.</small>
                        </td>
                        <td style="text-align:right;">
                            <span id="sys-redis-status" class="status-badge status-unknown">...</span>
                            <button id="btn-redis-fix" onclick="configureRedis()" style="margin-left:10px; padding:4px 10px; font-size:0.8em; display:none;" class="btn-warning">Fix Config</button>
                        </td>
                    </tr>
                </table>
            </div>
            
            <div class="card">
                <h3>FTP Server (Camera Uploads)</h3>
                <p>Create dedicated FTP accounts mapping to Nextcloud.</p>
                
                <form onsubmit="setupFtp(event)">
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap:15px;">
                        <div><label>NC User</label><input type="text" id="ftp-nc-user" placeholder="admin"></div>
                        <div><label>FTP User</label><input type="text" id="ftp-user" placeholder="camera1"></div>
                    </div>
                    <label>FTP Password</label><input type="password" id="ftp-pass">
                    
                    <button type="submit" class="btn-primary" style="width:100%; margin-top:5px;">Create / Update User</button>
                </form>
        
                <hr>
                <label>Active FTP Users</label>
                <div id="ftp-user-list" style="min-height:50px;">Loading...</div>
                <button onclick="loadFtpUsers()" style="margin-top:10px; font-size:0.8em; padding:6px 12px;">Refresh List</button>
            </div>

            {% if ha_domain %}
            <div class="card">
                <h3>Home Assistant Hardware</h3>
                <p>Pass-through Zigbee/Z-Wave USB dongles.</p>
                <label>Select Serial Device</label>
                <div style="display:flex; gap:10px;">
                    <select id="zigbee-device" style="margin-bottom:0; flex-grow:1;">
                        <option value="none">None</option>
                    </select>
                    <button onclick="updateZigbee()">Save</button>
                </div>
            </div>
            {% endif %}

        </div>
    </div>

    <div id="logs" class="tab-content">
        <div class="card">
            <h3>System Logs</h3>
            <div style="display:flex; gap:15px; margin-bottom: 15px;">
                <select id="log-selector" onchange="changeLogSource(this.value)" style="flex-grow:1; margin-bottom:0;">
                    <optgroup label="System Logs">
                        <option value="manager" selected>Manager (Dashboard App)</option>
                        <option value="setup">Setup Log</option>
                        <option value="backup">Backup Log</option>
                        <option value="restore">Restore Log</option>
                        <option value="update">Manager Update Log</option>
                    </optgroup>
                    <optgroup label="Service Containers">
                        <option value="nextcloud">Nextcloud Container</option>
                        <option value="db">Database Container</option>
                        <option value="homeassistant">Home Assistant Container</option>
                        <option value="newt">Pangolin (Newt) Container</option>
                        <option value="cloudflared-nc">Cloudflare (NC) Container</option>
                        <option value="cloudflared-ha">Cloudflare (HA) Container</option>
                    </optgroup>
                </select>
                <button onclick="pollLogs()">Refresh Now</button>
            </div>
            
            <div style="display:flex; gap:15px; margin-bottom:10px; font-size:0.9em; align-items:center; background:#111; padding:8px; border-radius:4px; border:1px solid #333;">
                <span style="color:#888; font-weight:bold;">FILTERS:</span>
                <label style="display:inline; margin:0; cursor:pointer;"><input type="checkbox" id="chk-error" checked onchange="renderLogs()"> Errors</label>
                <label style="display:inline; margin:0; cursor:pointer;"><input type="checkbox" id="chk-warn" checked onchange="renderLogs()"> Warnings</label>
                <label style="display:inline; margin:0; cursor:pointer;"><input type="checkbox" id="chk-info" checked onchange="renderLogs()"> Info</label>
                <label style="display:inline; margin:0; cursor:pointer;"><input type="checkbox" id="chk-debug" onchange="renderLogs()"> Debug/Raw</label>
                <div style="flex-grow:1; text-align:right;">
                    <small style="color:#666;" id="log-status">Ready</small>
                </div>
            </div>

            <div id="console-output" class="log-box">Select a log source...</div>
        </div>
    </div>

    <script>
        let currentLogSource = 'manager';
        let rawLogData = ""; // Store raw text for client-side filtering

        // --- Global Error Capture (Client-Side Logging) ---
        window.onerror = function(msg, url, line) {
            // Send JS errors to backend manager log
            fetch('/api/logs/client', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    level: 'ERROR',
                    message: `JS Error: ${msg} (${url}:${line})`
                })
            }).catch(e => console.warn("Failed to ship log", e));
        };

        async function init() {
            // Populate Hours for Backup
            const hourSel = document.getElementById('bk-hour');
            if (hourSel) {
                for (let i = 0; i < 24; i++) {
                    let opt = document.createElement('option');
                    opt.value = i;
                    opt.innerText = i.toString().padStart(2, '0') + ':00';
                    hourSel.appendChild(opt);
                }
            }
        
            // Initial Fetch
            try {
                // Parallel fetch for speed
                await Promise.all([fetchStatus(), pollTask()]);
                // Load heavy stuff lazily or on tab open
            } catch (err) {
                console.error("Initial fetch failed:", err);
            }
        
            // Start Intervals
            setInterval(fetchStatus, 5000);
            setInterval(pollTask, 2000);
            
            setInterval(() => {
                const logsTab = document.getElementById('logs');
                if (logsTab && logsTab.classList.contains('active')) {
                    pollLogs();
                }
            }, 3000);
        }

        function openTab(id) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Highlight button
            const btns = document.querySelectorAll('.tab-btn');
            btns.forEach(b => {
                if(b.getAttribute('onclick').includes(id)) b.classList.add('active');
            });

            // Lazy load tab-specific data
            if (id === 'backup') {
                loadDrives();
                loadBackups();
                loadBackupConfig();
                loadDiskStats();
            }
            if (id === 'logs') {
                pollLogs();
            }
            if (id === 'settings') {
                loadSystemConfig();
                loadSerialDevices();
                loadFtpUsers();
            }
        }

        async function fetchStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();

                // Services Status
                ['nc', 'db', 'ha', 'tunnel'].forEach(k => {
                    const el = document.getElementById('st-' + k);
                    if (el) setStatus(el, data[k === 'nc' ? 'nextcloud' : (k === 'tunnel' ? 'tunnel' : (k === 'ha' ? 'homeassistant' : 'db'))]);
                });
                
                if (document.getElementById('st-maint')) 
                    document.getElementById('st-maint').innerText = (data.maintenance_mode || 'unknown').toUpperCase();

                // Stats
                if (data.cpu_load !== undefined) document.getElementById('sys-cpu').innerText = data.cpu_load + "%";
                if (data.ram_text !== undefined) document.getElementById('sys-ram').innerText = data.ram_text + " (" + data.ram_percent + "%)";

                // Root Disk
                if (data.root_percent !== undefined) {
                    const bar = document.getElementById('root-bar');
                    bar.style.width = data.root_percent + '%';
                    bar.style.backgroundColor = data.root_percent > 85 ? 'var(--hb-danger)' : 'var(--hb-green)';
                    document.getElementById('root-text').innerText = data.root_percent + "% Used (" + data.root_free_gb + " GB Free)";
                }

            } catch (e) { }
        }

        function setStatus(el, status) {
            el.className = 'status-badge status-' + (status || 'unknown');
            el.innerText = (status || 'unknown').toUpperCase();
        }

        async function pollTask() {
            try {
                const res = await fetch('/api/task_status');
                const data = await res.json();
                const banner = document.getElementById('global-status');
                
                if(data.status === 'idle') {
                    banner.innerText = 'System Active';
                    banner.style.color = 'var(--hb-green)';
                } else if (data.status === 'running') {
                    banner.innerText = data.message;
                    banner.style.color = 'var(--hb-warning)';
                } else if (data.status === 'error') {
                    banner.innerText = 'Error: ' + data.message;
                    banner.style.color = 'var(--hb-danger)';
                } else {
                    banner.innerText = data.message;
                }

                // Auto switch log view if setup/update is running
                if ((data.log_type === 'setup' || data.log_type === 'update') && data.status === 'running') {
                     // Only switch if we aren't already looking at it to avoid annoyance
                     // currentLogSource = data.log_type; 
                }
            } catch(e) {}
        }

        // --- Tunnel Logic ---
        function showCloudflareForm() {
            document.getElementById('cf-form-container').style.display = 'block';
        }

        document.getElementById('tun-main-domain').addEventListener('input', function(e) {
            const val = e.target.value || '...';
            document.getElementById('preview-mgr').innerText = val;
            document.getElementById('preview-nc').innerText = val;
            document.getElementById('preview-ha').innerText = val;
        });

        async function updatePangolin(e) {
            e.preventDefault();
            const data = {
                endpoint: document.getElementById('tun-ep').value,
                id: document.getElementById('tun-id').value,
                secret: document.getElementById('tun-sec').value,
                main_domain: document.getElementById('tun-main-domain').value
            };
            if (confirm("Update Pangolin settings? This will update all service URLs and restart tunnels.")) {
                triggerAction('/api/tunnel', 'Update Tunnel', data);
                setTimeout(() => location.reload(), 3000);
            }
        }

        async function revertPangolin() {
            if (confirm("Revert Pangolin to factory defaults (including domains)?")) {
                triggerAction('/api/tunnel', 'Revert Tunnel', { action: 'revert' });
                setTimeout(() => location.reload(), 3000);
            }
        }

        async function updateCloudflare(e, mode) {
            e.preventDefault();
            const prefix = mode === 'switch' ? 'cf-switch-' : 'cf-update-';
            const token = document.getElementById(prefix + 'token').value;
            const service = document.getElementById(prefix + 'service').value;
            const domain = document.getElementById(prefix + 'domain').value;

            if (!token) return alert("Token required");
            if (!domain && mode === 'switch') return alert("Domain required");

            if (confirm("Switch/Update Cloudflare Tunnel?")) {
                triggerAction('/api/tunnel/cloudflare', 'Cloudflare Update', { domain: domain, token: token, service: service });
                setTimeout(() => location.reload(), 3000);
            }
        }

        async function revertToFactory() {
            if (confirm("Disable Cloudflare and revert to Factory Pangolin settings?")) {
                triggerAction('/api/tunnel/revert', 'Revert to Factory', {});
                setTimeout(() => location.reload(), 3000);
            }
        }

        // --- Settings Tab Logic ---
        async function loadSystemConfig() {
            try {
                const res = await fetch('/api/system/config');
                const data = await res.json();
                
                const updateBadge = (id, val, activeVal) => {
                    const el = document.getElementById(id);
                    el.innerText = val.toUpperCase();
                    el.className = 'status-badge status-' + (val === activeVal ? 'running' : 'stopped');
                    el.dataset.val = val;
                };

                updateBadge('sys-wd-status', data.watchdog, 'enabled');
                updateBadge('sys-cron-status', data.cron, 'cron'); // cron enabled = 'cron'
                updateBadge('sys-pci-status', data.pci, 'gen3');

                checkRedisStatus();
                
            } catch(e) { console.error("Sys Config Load Error", e); }
        }

        async function toggleSystem(feature) {
            let action = "";
            let confirmMsg = "";
            const el = document.getElementById(feature === 'watchdog' ? 'sys-wd-status' : (feature === 'cron' ? 'sys-cron-status' : 'sys-pci-status'));
            const current = el.dataset.val;
    
            if (feature === 'watchdog') {
                action = current === 'enabled' ? 'disable' : 'enable';
                confirmMsg = `${action.toUpperCase()} Hardware Watchdog?`;
            } 
            else if (feature === 'cron') {
                action = 'enable'; 
                confirmMsg = "Enforce System Cron for Nextcloud?";
            }
            else if (feature === 'pci') {
                action = current === 'gen3' ? 'disable' : 'enable'; 
                confirmMsg = `Switch PCIe to ${action === 'enable' ? 'GEN 3 (Experimental)' : 'Gen 2 (Stable)'}?\nA reboot will be required.`;
            }
    
            if (confirm(confirmMsg)) {
                triggerAction('/api/system/config', 'System Config', { feature: feature, action: action });
                setTimeout(loadSystemConfig, 3000);
            }
        }

        async function checkRedisStatus() {
            try {
                const res = await fetch('/api/redis/status');
                const data = await res.json();
                const el = document.getElementById('sys-redis-status');
                const btn = document.getElementById('btn-redis-fix');
                
                if (data.status === 'connected') {
                    el.innerText = 'ACTIVE';
                    el.className = 'status-badge status-running';
                    btn.style.display = 'none';
                } else if (data.status === 'unconfigured') {
                    el.innerText = 'UNCONFIGURED';
                    el.className = 'status-badge status-starting'; // Yellow/Orange
                    btn.style.display = 'inline-block';
                } else {
                    el.innerText = 'OFFLINE';
                    el.className = 'status-badge status-stopped';
                    btn.style.display = 'none';
                }
            } catch(e) {}
        }
    
        async function configureRedis() {
            if (confirm("Configure Nextcloud to use Redis for caching/locking?")) {
                triggerAction('/api/redis/configure', 'Redis Configuration');
                // Poll status after a delay
                setTimeout(checkRedisStatus, 5000);
            }
        }

        // --- FTP Logic ---
        async function loadFtpUsers() {
            const el = document.getElementById('ftp-user-list');
            el.innerText = 'Loading...';
            try {
                const res = await fetch('/api/ftp/users');
                const users = await res.json();
                
                if (users.length === 0) {
                    el.innerHTML = '<em style="color:#666;">No FTP users configured.</em>';
                    return;
                }
                
                let html = '<table><thead><tr><th>FTP User</th><th>Nextcloud User</th><th>Action</th></tr></thead><tbody>';
                users.forEach(u => {
                    html += `<tr>
                        <td>${u.ftp_user}</td>
                        <td>${u.nc_user}</td>
                        <td style="text-align:right"><button class="btn-danger" onclick="deleteFtpUser('${u.ftp_user}')" style="padding:4px 8px; font-size:0.8em;">Delete</button></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                el.innerHTML = html;
            } catch (e) { el.innerText = 'Failed to load users.'; }
        }

        async function setupFtp(e) {
            e.preventDefault();
            const ncUser = document.getElementById('ftp-nc-user').value || 'admin';
            const ftpUser = document.getElementById('ftp-user').value;
            const ftpPass = document.getElementById('ftp-pass').value;

            if(confirm(`Create FTP user '${ftpUser}' mapped to Nextcloud user '${ncUser}'?`)) {
                 triggerAction('/api/ftp/setup', 'FTP Setup', { nc_user: ncUser, ftp_user: ftpUser, ftp_pass: ftpPass });
                 document.getElementById('ftp-pass').value = '';
            }
        }

        async function deleteFtpUser(user) {
            if(confirm(`Delete FTP user '${user}'?`)) {
                triggerAction('/api/ftp/delete', 'Delete FTP User', { ftp_user: user });
                setTimeout(loadFtpUsers, 3000);
            }
        }

        // --- Zigbee Logic ---
        async function loadSerialDevices() {
            try {
                const res = await fetch('/api/hardware/serial');
                const devices = await res.json();
                const sel = document.getElementById('zigbee-device');
                
                // Save current selection if possible
                const currentRes = await fetch('/api/manager/zigbee');
                const currentData = await currentRes.json();
                const activeDev = currentData.current || 'none';

                sel.innerHTML = '<option value="none">None</option>';
                if (devices.length === 0) {
                     const opt = document.createElement('option');
                     opt.disabled = true;
                     opt.innerText = "No USB Devices Found";
                     sel.appendChild(opt);
                } else {
                    devices.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d;
                        opt.innerText = d;
                        sel.appendChild(opt);
                    });
                }
                sel.value = activeDev;
            } catch (e) {}
        }
        
        async function updateZigbee() {
            const dev = document.getElementById('zigbee-device').value;
            triggerAction('/api/manager/zigbee', 'Zigbee Config', { device: dev });
        }

        // --- Standard Helpers (Backup, Drive, Logs) ---
        async function loadDrives() {
            const el = document.getElementById('drive-list');
            el.innerHTML = 'Scanning...';
            try {
                const res = await fetch('/api/drives');
                const drives = await res.json();
                el.innerHTML = '';
                if (drives.length === 0) el.innerHTML = 'No external drives found.';

                drives.forEach(d => {
                    const div = document.createElement('div');
                    div.className = 'drive-row';
                    
                    let html = `<div><strong>${d.path}</strong> <span style="color:#aaa">(${d.size})</span> <small>${d.model}</small></div>`;
                    
                    if (d.is_backup) {
                        html += '<span class="status-badge status-running">Backup Drive</span>';
                    } else {
                        html += `<div>
                            <button class="btn-warning" style="font-size:0.8em; margin-right:5px;" onclick="mountDrive('${d.path}')">Mount</button>
                            <button class="btn-danger" style="font-size:0.8em;" onclick="formatDrive('${d.path}')">Format</button>
                        </div>`;
                    }
                    div.innerHTML = html;
                    el.appendChild(div);
                });
            } catch (e) { el.innerHTML = 'Error loading drives'; }
        }

        async function mountDrive(path) {
            if (confirm(`Mount ${path} as the backup drive? Existing data will be kept.`)) {
                triggerAction('/api/drives/mount', 'Mount Drive', { path: path });
            }
        }

        async function formatDrive(path) {
            if (confirm(`DANGER: This will ERASE ALL DATA on ${path}.\n\nAre you sure?`)) {
                const check = prompt(`Type 'FORMAT' to confirm formatting ${path}`);
                if (check === "FORMAT") {
                    triggerAction('/api/drives/format', 'Format Drive', { path: path });
                }
            }
        }

        async function loadDiskStats() {
            try {
                const res = await fetch('/api/backup/stats');
                const d = await res.json();
                const bar = document.getElementById('disk-bar');
                const txt = document.getElementById('disk-text');

                if (d.mounted) {
                    bar.style.width = d.percent + '%';
                    txt.innerText = `${d.used_gb} GB Used / ${d.total_gb} GB Total`;
                    bar.style.backgroundColor = d.percent > 90 ? 'var(--hb-danger)' : 'var(--hb-green)';
                } else {
                    bar.style.width = '0%';
                    txt.innerText = 'Not Mounted';
                }
            } catch (e) { }
        }

        async function loadBackupConfig() {
            fetch('/api/backup/config')
                .then(res => res.json())
                .then(d => {
                    d = d || {};  // Handle empty response
                    // Apply robust defaults if keys are missing
                    if (!d.retention) d.retention = 7;
                    if (!d.hour) d.hour = 3;
                    if (d.minute === undefined || d.minute === null) d.minute = 0;
                    if (!d.day_week) d.day_week = '*';
                    if (!d.day_month) d.day_month = '*';
                    if (!Object.keys(d).length) {
                        console.warn("Backup config empty; loading defaults.");
                    }
                    
                    // Update Form Elements
                    document.getElementById('bk-retention').value = d.retention;
                    document.getElementById('bk-hour').value = d.hour;
                    document.getElementById('bk-min').value = d.minute;

                    let freq = 'daily';
                    if (d.day_week !== '*') {
                        freq = 'weekly';
                        document.getElementById('bk-dow').value = d.day_week;
                    } else if (d.day_month !== '*') {
                        freq = 'monthly';
                        document.getElementById('bk-dom').value = d.day_month;
                    }
                    document.getElementById('bk-freq').value = freq;
                    updateFreqUI();
                })
                .catch(e => console.error("Failed to load backup config:", e));
        }

        function updateFreqUI() {
            const freq = document.getElementById('bk-freq').value;
            document.getElementById('ui-dow').style.display = freq === 'weekly' ? 'block' : 'none';
            document.getElementById('ui-dom').style.display = freq === 'monthly' ? 'block' : 'none';
        }

        async function saveBackupConfig(e) {
            e.preventDefault();
            const freq = document.getElementById('bk-freq').value;
            let dow = '*', dom = '*';
            if (freq === 'weekly') dow = document.getElementById('bk-dow').value;
            if (freq === 'monthly') dom = document.getElementById('bk-dom').value;

            const body = {
                retention: document.getElementById('bk-retention').value,
                hour: document.getElementById('bk-hour').value,
                minute: document.getElementById('bk-min').value,
                day_week: dow, day_month: dom
            };

            const res = await fetch('/api/backup/config', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            if (res.ok) alert("Schedule Saved."); else alert("Error saving schedule.");
        }

        async function runBackup() {
            const s = document.getElementById('backup-strategy').value;
            triggerAction('/api/backup/now', 'Manual Backup', { strategy: s });
        }

        async function loadBackups() {
            try {
                const res = await fetch('/api/backups/list');
                const list = await res.json();
                const sel = document.getElementById('backup-list');
                sel.innerHTML = '';
                list.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.name;
                    opt.innerText = `${b.name} (${b.type}, ${b.size})`;
                    sel.appendChild(opt);
                });
            } catch(e) {}
        }

        async function confirmRestore() {
            const file = document.getElementById('backup-list').value;
            if (!file) return;
            const check = prompt(`DANGER: This will WIPE ALL DATA and restore ${file}.\n\nType 'RESTORE' to confirm:`);
            if (check === "RESTORE") {
                triggerAction('/api/restore', 'Restore', { filename: file });
            }
        }

        async function triggerAction(endpoint, name, body = {}) {
            try {
                const res = await fetch(endpoint, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
                });
                const data = await res.json();
                // Fix: Accept both 'started' (async task) and 'success' (immediate/custom) status codes
                if (data.status === 'started' || data.status === 'success') {
                    // Use specific server message if provided, otherwise default text
                    alert(data.message || `${name} started successfully.`);
                    pollTask();
                } else {
                    alert("Error: " + (data.error || "Unknown"));
                }
            } catch (e) { alert("Request failed"); }
        }

        async function toggleMaintenance(mode) {
            await fetch('/api/maintenance/mode', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ mode: mode }) });
            setTimeout(fetchStatus, 1000);
        }

        let pendingUpdateTarget = "";
        function resetUpdateUI() {
            document.getElementById('update-msg').innerText = "";
            document.getElementById('btn-do-update').style.display = "none";
        }

        async function checkManagerUpdate() {
            const btn = document.getElementById('btn-check-update');
            const msg = document.getElementById('update-msg');
            const doBtn = document.getElementById('btn-do-update');
            const channel = document.getElementById('update-channel').value;
 
            btn.disabled = true;
            btn.innerText = "Checking...";
            msg.innerText = "";
            doBtn.style.display = "none";
 
            try {
               const res = await fetch(`/api/manager/check_update?channel=${channel}`);
               const data = await res.json();
               pendingUpdateTarget = data.target_ref;
                
               if (data.available) {
                   msg.innerText = data.message;
                   msg.style.color = "var(--hb-green)";
                   doBtn.style.display = "inline-block";
                   doBtn.innerText = `Install ${data.target_ref}`;
               } else {
                   msg.innerText = data.message;
                   msg.style.color = "#ccc";
               }
            } catch (e) {
                msg.innerText = "Check failed.";
                msg.style.color = "var(--hb-danger)";
            } finally {
                btn.disabled = false;
                btn.innerText = "Check App Update";
            }
        }
 
        async function doManagerUpdate() {
            const channel = document.getElementById('update-channel').value;
            if (!confirm(`Update HomeBrain Manager to ${channel} ${pendingUpdateTarget}? The interface will restart.`)) return;
            
            const res = await fetch('/api/manager/update', { 
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ channel: channel, target_ref: pendingUpdateTarget })
            });
            const data = await res.json();
            if (data.status === 'started') {
                alert("Update started. The page will reload in 15 seconds.");
                setTimeout(() => location.reload(), 15000);
            } else {
                alert("Update failed to start: " + (data.error || "Unknown error"));
            }
        }

        function changeLogSource(val) {
            currentLogSource = val;
            pollLogs();
        }

        async function pollLogs() {
            const statusEl = document.getElementById('log-status');
            statusEl.innerText = "Fetching...";
            try {
                const res = await fetch('/api/logs/' + currentLogSource);
                const txt = await res.text();
                
                // Only re-render if data changed
                if (txt !== rawLogData) {
                    rawLogData = txt;
                    renderLogs();
                    statusEl.innerText = "Updated " + new Date().toLocaleTimeString();
                } else {
                    statusEl.innerText = "No changes";
                }
            } catch(e){}
        }

        function renderLogs() {
            const div = document.getElementById('console-output');
            const lines = rawLogData.split('\n');
            
            // Get active filters
            const showErr = document.getElementById('chk-error').checked;
            const showWarn = document.getElementById('chk-warn').checked;
            const showInfo = document.getElementById('chk-info').checked;
            const showDebug = document.getElementById('chk-debug').checked;

            let html = '';
            
            lines.forEach(line => {
                if (!line.trim()) return;
                
                let cssClass = 'log-debug';
                let visible = false;

                // Simple heuristic detection of log levels
                const upper = line.toUpperCase();
                
                if (upper.includes('ERROR') || upper.includes('CRITICAL') || upper.includes('EXCEPTION') || upper.includes('TRACEBACK')) {
                    cssClass = 'log-error';
                    if (showErr) visible = true;
                } else if (upper.includes('WARN')) {
                    cssClass = 'log-warning';
                    if (showWarn) visible = true;
                } else if (upper.includes('INFO')) {
                    cssClass = 'log-info';
                    if (showInfo) visible = true;
                } else {
                    // Fallback for raw lines or stack traces (usually inherit or debug)
                    if (showDebug) visible = true;
                }

                if (visible) {
                    html += `<div class="log-line ${cssClass}">${escapeHtml(line)}</div>`;
                }
            });

            div.innerHTML = html;
            div.scrollTop = div.scrollHeight;
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        init();
    </script>
</body>
</html>