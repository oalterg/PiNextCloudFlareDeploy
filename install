#!/bin/bash
# install â€” Bootstrapper

set -Eeuo pipefail

# --- Configuration ---
INSTALL_DIR="/opt/homebrain"
BIN_DIR="/usr/local/sbin"
LOG_DIR="/var/log/homebrain"
# Use a specific branch/tag for stability, or 'main' for latest
REPO_URL="https://github.com/oalterg/homebrain/archive/refs/heads/main.tar.gz"

if [[ ${EUID:-$(id -u)} -ne 0 ]]; then echo "Run as root."; exit 1; fi

echo "=== Bootstrapper Started ==="
mkdir -p "$LOG_DIR" "$INSTALL_DIR"

# 1. Install Unpacking Dependencies
apt-get update -qq
apt-get install -y curl tar gzip

# 2. Download and Extract Repository
echo "Downloading repository..."
# --strip-components=1 removes the root folder (e.g., repo-main/) from the tarball
curl -L "$REPO_URL" | tar -xz --strip-components=1 -C "$INSTALL_DIR"

# 3. Setup Permissions
chmod +x "$INSTALL_DIR/scripts/provision.sh"
chmod +x "$INSTALL_DIR/scripts/raspi-cloud"

# 4. Symlink Binary
ln -sf "$INSTALL_DIR/scripts/raspi-cloud" "$BIN_DIR/raspi-cloud"

echo "Installation complete."
echo "Run '$INSTALL_DIR/scripts/provision.sh' to configure the device."